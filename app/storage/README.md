СКЛАД
====================

При создании задачи для производства (manufacture) создаются и номенклатуры (nomenclature). Для каждой номенклатуры вызывается сигнал `create_user_report` 
В нем происходит резервирование компонентов (`component`) для номенклатуры.

При добавлении компонента на склад сначала проверяется потребности и резервируются компоненты для номенклатур, которые их используют. Если таких номенклатур нет, компоненты просто добавляются на склад.

После отгрузки изделия (manufacture) каждый компонент номенклатур в составе изделия переходит в архив. (помечается флагом `is_archive`), это нужно для фильтрации только активных номенклатур и для истории отправок


Процесс резервирования
-----------------

Процесс резервирования начинается с вызова функции processing_reserved_component(nomenclature). Эта функция получает список типов компонентов для данной номенклатуры и затем резервирует каждый компонент этого типа.

Резервирование компонента осуществляется путем вызова функции `reserve_component(component_type, nomenclature)`. Эта функция проверяет, существует ли уже компонент этого типа, который может быть зарезервирован. Если такой компонент существует, он обновляется и помечается как зарезервированный. Если такого компонента не существует, он создается и помечается как зарезервированный.


Процесс резервирования
-----------------------
### Функции
`processing_reserved_component(nomenclature: Nomenclature)`
Эта функция принимает объект `Nomenclature` в качестве аргумента. Она получает список типов компонентов, связанных с этой номенклатурой, и затем резервирует каждый компонент этого типа.

`get_components_type_from_nomenclature(nomenclature: Nomenclature) -> list[ComponentType] | None`
Эта функция принимает объект Nomenclature и возвращает список типов компонентов, связанных с этой номенклатурой. Если тип компонента не найден, функция пропускает его и продолжает со следующим компонентом.

`get_sub_component_from_component(component_type: ComponentType) -> list[ComponentType]`
Эта функция принимает объект `ComponentType` и возвращает список всех подкомпонентов этого типа компонента.


#### reserve_component
`reserve_component(component_type: ComponentType, nomenclature: Nomenclature)`

Эта функция принимает объекты `ComponentType` и `Nomenclature` и резервирует компонент этого типа для данной номенклатуры. Если компонент уже существует и доступен для резервирования, он обновляется и помечается как зарезервированный. Если такого компонента не существует, он создается и помечается как зарезервированный.

Функция начинает свою работу с создания условий для поиска компонентов, которые можно зарезервировать. Она ищет компоненты, которые находятся на складе `(is_stock=True)`, и которые еще не зарезервированы `(is_reserve=False)`.

Если у номенклатуры есть производитель и дата отгрузки, функция также ищет компоненты, у которых дата поставки не пуста и меньше или равна дате отгрузки производителя.

Затем функция ищет компоненты, которые соответствуют этим условиям и имеют указанный тип компонента.

Если такие компоненты найдены, функция берет первый из них, обновляет его поля `nomenclature` для фиксации за какой номенклатурой  и `is_reserve` и сохраняет изменения. В противном случае функция создает новый компонент с указанным типом компонента, номенклатурой и помечает его как зарезервированный.

В обоих случаях функция записывает в лог информацию о том, был ли компонент обновлен или создан.



Добавление компонента на склад
-----------------------
### Резервация и создание компонентов

1. метод извлекает количество компонентов и флаг генерации серийного номера из формы.
2. Если флаг генерации серийного номера установлен, генерирует серийный номер для каждого компонента.
3. Пытается зарезервировать существующий компонент с помощью метода `reserve_exist_component`. Если резервация успешна, уменьшает количество компонентов, которые нужно создать.
4. Для каждого оставшегося компонента, который нужно создать, генерирует серийный номер (если нужно)

### Методы
Методы `get_components_to_reserve` и `get_components_to_reserve_by_date_delivery`

Эти методы возвращают компоненты, которые можно зарезервировать. Они принимают тип компонента (и дату поставки для `get_components_to_reserve_by_date_delivery`) и возвращают компоненты, которые соответствуют этому типу
- являются резервными
- не находятся на складе и
- не имеют даты поставки.


Доставка
---------------------
### Создание доставки

При создании доставки создаются компоненты на склад, которые не в наличии и имеют дату доставки 
При создании доставки ищутся компоненты, которые можно зарезервировать (которые в потребности и у который дата отгрузки наступит после даты доставки )


### Изменение даты доставки
Во время изменения даты доставки изменяется и дата доставки каждого компонента в составе этой доставки
При этом происходит перерезервирование компонента, если он был зарезервирован
    - Проверяется резервация компонента
    - Если дата доставки компонента позже чем дата отгрузки, ищется новый компонент для резервации
    - Если компонент не найден, создается "потребность" в компоненте (создается новый компонент без наличия и с резервацией под номенклатуру)

Например: 

