{% extends 'ticsys/index.html' %}
{% block content %}
<h1>Заявка №{{ticket.pk}}</h1>

<div class="ui grid container">
  <div class="four wide column">
    <div class="ui list">
      {% if ticket.phone%}
      <div class="item">
        <i class="phone icon"></i>
        <div class="content">
          <a href="tel:{{ticket.phone}}"> {{ticket.phone}}</a>
        </div>
      </div>
      {%endif%}
      {% if ticket.address%}
      <div class="item">
        <i class="marker icon"></i>
        <div class="content">
          {{ticket.address}}
        </div>
      </div>
      {%endif%}
      {% if ticket.shop_id%}
      <div class="item">
        <i class="store alternate icon"></i>
        <div class="content">
          {{ticket.shop_id}}
        </div>
      </div>
      {%endif%}
      {% if ticket.full_name%}
      <div class="item">
        <i class="user icon"></i>
        <div class="content">
          {{ticket.full_name}}
        </div>
      </div>
      {%endif%}
      {% if ticket.position%}
      <div class="item">
        <i class="id badge icon"></i>
        <div class="content">
          {{ticket.position}}
        </div>
      </div>
      {%endif%}
      {% if ticket.sap_id%}
      <div class="item">
        <i class="ticket icon"></i>
        <div class="content">
          SAP: {{ticket.sap_id}}
        </div>
      </div>
      {%endif%}
      {% if ticket.metadata%}
      <div class="item">
        <i class="info icon"></i>
        <div class="content">
          {{ticket.metadata}}
        </div>
      </div>
      {%endif%}

    </div>
  </div>
  <div class="twelve wide column">
    <div class="ui   ">
      <div class="ui horizontal list">    
        <div class="item"> 
          <div class="header"> Тип</div> 
          {% firstof ticket.type_ticket "<i>Не назначен</i>"%}

        </div>
        <div class="item"> 
          <div class="header"> Заказчик</div> 
          {{ticket.customer}}
        </div>
        <div class="item"> 
          <div class="header"> Исполнитель</div> 
          {% firstof ticket.contractor "<i>Не назначен</i>" %}
        </div>
        <div class="item"> 
          <div class="header"> Статус</div> 
          {% if ticket.status %} <div class="ui {{ticket.get_color_status}} label">{{ticket.status}}</div>{% endif %}
        </div>
        <div class="item"> 
          <div class="header"> Плановая дата выезда/исполнения</div> 
          {% if ticket.planned_execution_date %}
          {{ticket.planned_execution_date}}
          {% else%}
          <i>Не назначена</i>
          {% endif %}
        </div>
      </div>
      <div class=" ui list ">
        <div class="item"> 
          <div class="header"> Описание</div> 
          <div class="ui large text">
          {{ticket.description|safe }}
          </div>
        </div>
      </div>        
      {% if user.is_operator %}
      <div id="run_modal" class="ui right floated button ">Изменить</div>
      {% endif %}
      <a href="{% url 'comment-update' ticket.pk %}" class="ui right floated info button ">Добавить комментарий</a>
    </div>
  </div>
<div class="ui comments">
{% for comment in ticket.comments.all %}
<div class="comment">
  <a class="avatar">
    <img src="{{comment.author.get_avatar}}">
  </a>
  <div class="content">
    <a class="author">{{comment.author}}</a>
    <div class="metadata">
      <span class="date">{{comment.date_create|date}}</span>
    </div>
    <div class="text">
    {% if comment.text %}
      {{comment.text|safe }}}}
    {% else %}
      <i>No text</i>
      {% endif %}
    </div>
    
    {% if comment.files %}
    <div class="text">
      <div class="ui list">
        {% for file in comment.files.all %}
        <div class="item">
          <i class="file icon"></i>
          <div class="content">
            <a href="{{file.file.url}}"> {{file.file_name}}</a>
          </div>
        </div>
        {% endfor %}
      </div>
      
    </div>
    
    {% endif %}
    
  </div>
</div>
{% endfor %}
</div>

<div class="ui modal">
  <i class="close icon"></i>
  <div class="header">Изменить заявку</div>
  <div class="content">
    <form class="ui form" method="post">
        {{ form.non_field_errors }}
        {% csrf_token %}
        {% for field in form %}
        <div class="field">
            {{ field.errors }}
            {% if not field.is_hidden%}
            {{ field.label_tag }} 
            {% endif %}
            {{ field }}
        </div>
        {% endfor %}
        <button class="ui button" type="submit">Изменить</button>
    </form>
  </div>
</div>
{% endblock content %}
{% block script %}
<script>
  $('.ui.modal')
  .modal('attach events', '#run_modal', 'show');

  $('#date_calendar').calendar({
    type: "date",
    firstDayOfWeek: 1,
    text: {
      days: ['В', 'П', 'В', 'С', 'Ч', 'П', 'С'],
        today: 'Сегодня',
        months: ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"],
        monthsShort: ["Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"],
      },
      formatter: {
        date: 'DD.MM.YYYY'
      },
  });
</script>
{% endblock script %}