{% extends 'ticsys/index.html' %}
{% load static %}
{% block header_style %}
<link rel="stylesheet" type="text/css" href="{% static 'DataTables/DataTables-1.13.1/css/dataTables.semanticui.min.css' %}"/> 
<script type="text/javascript" src="{% static 'DataTables/DataTables-1.13.1/js/jquery.dataTables.min.js' %}"></script>
<script type="text/javascript" src="{% static 'DataTables/DataTables-1.13.1/js/dataTables.semanticui.min.js' %}"></script>
{% endblock %}

{% block content %}
<h1>Заявки</h1>
{% comment %} <div class="ui icon right floated pointing multiple dropdown button "> {% endcomment %}
  <div class="ui multiple right floated dropdown labeled icon button " id="filterBtn">
    <input type="hidden" name="filters">
    <i class="filter icon"></i>
    <span class="text">Скрыть статусы</span>
    <div class="menu">
  
      <div class="scrolling menu">
        {% for status in statuses %}
        <div class="item" data-value="{{status.description}}">
          <div class="ui {{status.get_status_color}} empty circular label"></div>
          {{status.description}}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
<table id="tableTickets"class="ui celled small compact table">
    <thead>
      <tr>
        <th id="id">ID</th>
        <th id="date_create">Дата создания</th>
        <th id="sap_id">SAP</th>
        <th id="type_ticket">Тип заявки</th>
        <th id="customer">Заказчик</th>
        <th id="responsible">Ответсвенный</th>
        {% if not user.is_customer %}
        <th id="contractor">Иполнитель</th>
        {% endif %}
        <th id="planned_execution_date"> Плановая дата выезда/исполнения</th>
        <th id="status">Статус</th>
        <th id="address">Город</th>
        <th id="shop_id">Магазин</th>
        <th>Подробнее</th>

    </tr></thead>
    <tbody>
      {% for ticket in object_list %}
      <tr>
        <td data-label="id">{{ticket.pk}}</td>
        <td data-label="date_create">{{ticket.date_create| date:"Y-m-d"}}</td>
        <td data-label="sap_id">{% firstof ticket.sap_id %}</td>
        <td data-label="type_ticket">{% firstof ticket.type_ticket %}</td>
        <td data-label="customer">{% firstof ticket.customer.get_role_user %}</td>
        <td data-label="responsible">{% firstof ticket.responsible %}</td>
        {% if not user.is_customer %}
        <td data-label="contractor">{% firstof ticket.contractor %}</td>
        {% endif %}
        <td data-label="planned_execution_date">{{ticket.planned_execution_date|date:"Y-m-d"}}</td>
        <td data-label="status">{% if ticket.status %} <div class="ui {{ticket.get_color_status}} label">{{ticket.status}}</div>{% endif %}</td>
        <td data-label="address">{% firstof ticket.city %}</td>
        <td data-label="shop_id">{% firstof ticket.shop_id %}</td>
        <td><a class="ui button info" target="_blank" href={% url 'ticket-update' ticket.pk %}>Просмотр</a></td>
      </tr>
      
        {% empty %}
        <tr>
          <td>No tickets yet.</td>
        <tr>
        {% endfor %}
      </tr>
    </tbody>
  </table>

{% endblock content %}
{% block script %}
<script>
    {% if  object_list%}
    var hidden_values = JSON.parse(localStorage.hidden_value || null) || false;
    if (hidden_values){
      let hidden_value_list = hidden_values.split(",");
      for (var i = 0; i < hidden_value_list.length; i++) {
        $("#filterBtn").dropdown('set selected', hidden_value_list[i]);
      }
      
    }

    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
      var status = data
      to_hide = $("#filterBtn").dropdown('get value');
      if (!to_hide){
        return true;
      }
      to_hide = to_hide.split(",");
      for (var i = 0; i < to_hide.length; i++) {
        to_hide[i] = to_hide[i].trim();
        if (status.indexOf(to_hide[i]) >= 0) {
          return false;
        }
      }
      return true;
    });
    var table = $('#tableTickets').DataTable({
      stateSave: true,
      columnDefs: [
            {
                targets: 1,
                render: DataTable.render.date(),
            },
            {
                targets: -5,
                render: DataTable.render.date(),
            },
        ],
        order: [[1, 'desc']],
        language: {
            url: "{% static 'DataTables/ru.json'%}"
        }
        
    });


    $("#filterBtn").dropdown({
      onChange: function (value, text, $selectedItem) {
        localStorage.setItem('hidden_value', JSON.stringify(value));
        
        table.draw();

      }
    })

    {% endif %}


</script>
{% endblock script %}