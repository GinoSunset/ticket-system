{% extends 'ticsys/index.html' %}
{% load static %}
{% block header_style %}
<link rel="stylesheet" type="text/css" href="{% static 'DataTables/DataTables-1.13.1/css/dataTables.semanticui.min.css' %}"/> 
<script type="text/javascript" src="{% static 'DataTables/DataTables-1.13.1/js/jquery.dataTables.min.js' %}"></script>
<script type="text/javascript" src="{% static 'DataTables/DataTables-1.13.1/js/dataTables.semanticui.min.js' %}"></script>
{% endblock %}

{% block content %}
<h1>Заявки</h1>

<div class="ui icon right floated pointing dropdown button ">
  <i class="wrench icon"></i>
  <div class="menu">
    <div class="header">Настройка отображения</div>
    <div class="item" onclick="toogle_hidden_done()"><i id="icon_hide_show" class="hide icon"></i><span id="hide_text">Скрыть завершенные</span></div>
  </div>
</div>
<table id="tableTickets"class="ui celled small compact table">
    <thead>
      <tr>
        <th id="id">ID</th>
        <th id="date_create">Дата создания</th>
        <th id="sap_id">SAP</th>
        <th id="type_ticket">Тип заявки</th>
        <th id="customer">Заказчик</th>
        <th id="responsible">Ответсвенный</th>
        {% if not user.is_customer %}
        <th id="contractor">Иполнитель</th>
        {% endif %}
        <th id="planned_execution_date"> Плановая дата выезда/исполнения</th>
        <th id="status">Статус</th>
        <th id="address">Город</th>
        <th id="shop_id">Магазин</th>
        <th>Подробнее</th>

    </tr></thead>
    <tbody>
      {% for ticket in object_list %}
      <tr>
        <td data-label="id">{{ticket.pk}}</td>
        <td data-label="date_create">{{ticket.date_create| date:"Y-m-d"}}</td>
        <td data-label="sap_id">{% firstof ticket.sap_id %}</td>
        <td data-label="type_ticket">{% firstof ticket.type_ticket %}</td>
        <td data-label="customer">{% firstof ticket.customer %}</td>
        <td data-label="responsible">{% firstof ticket.responsible %}</td>
        {% if not user.is_customer %}
        <td data-label="contractor">{% firstof ticket.contractor %}</td>
        {% endif %}
        <td data-label="planned_execution_date">{{ticket.planned_execution_date|date:"Y-m-d"}}</td>
        <td data-label="status">{% if ticket.status %} <div class="ui {{ticket.get_color_status}} label">{{ticket.status}}</div>{% endif %}</td>
        <td data-label="address">{% firstof ticket.city %}</td>
        <td data-label="shop_id">{% firstof ticket.shop_id %}</td>
        <td><a class="ui button info" target="_blank" href={% url 'ticket-update' ticket.pk %}>Просмотр</a></td>
      </tr>
      
        {% empty %}
        <tr>
          <td>No tickets yet.</td>
        <tr>
        {% endfor %}
      </tr>
    </tbody>
  </table>

{% endblock content %}
{% block script %}
<script>
    {% if  object_list%}
    var hidden_done = JSON.parse(localStorage.hidden_done || null) || false;
    if (hidden_done){
      $("#icon_hide_show").toggleClass("hide eye");
      $('#hide_text').text("Показать завершенные");
    }

    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
      var status = data

      if (status.indexOf("Выполнено") >= 0 && hidden_done ) {
          return false;
      }
      return true;
    });
    var table = $('#tableTickets').DataTable({
      stateSave: true,
      columnDefs: [
            {
                targets: 1,
                render: DataTable.render.date(),
            },
            {
                targets: -5,
                render: DataTable.render.date(),
            },
        ],
        order: [[1, 'desc']],
        language: {
            url: "{% static 'DataTables/ru.json'%}"
        }
        
    });


    $(".pointing.dropdown.button").dropdown()

    function toogle_hidden_done(){
      hidden_done = !hidden_done;
      localStorage.setItem('hidden_done', JSON.stringify(hidden_done));
      table.draw();
      $("#icon_hide_show").toggleClass("hide eye");
      var text = $('#hide_text').text();
      $('#hide_text').text(
        text == "Скрыть завершенные" ? "Показать завершенные" : "Скрыть завершенные");

    }
    {% endif %}


</script>
{% endblock script %}