{% extends 'ticsys/index.html' %}
{% block content %}
<h1>{% firstof name_page 'Создание задачи на производство' %}</h1>
<a class="ui button blue basic" href="{% url 'client-create' %}">Создать клиента</a>
<div class="ui container">
    <form class="ui form" method="post">
        {{ form.non_field_errors }}
        {% csrf_token %}
        <h4 class="ui dividing header">Общая информация</h4>
        <div class="three fields">
          <div class="field">
              <label>{{form.status.label}}</label>
              {{form.status}}
              {{form.status.errors}}
          </div>
          <div class="field">
              <label>{{form.client.label}}</label>
              {{form.client}}
              {{form.client.errors}}
          </div>
          <div class="field">
              <label>{{form.date_shipment.label}}</label>
              {{form.date_shipment}}
              {{form.date_shipment.errors}}
          </div>
        </div>
        <div class="ui segment">
          <div class="ui field toggle checkbox">
            {{form.branding}}
            {{form.branding.errors}}
            <label>Использовать брендирование</label>
          </div>
        </div>
        <div class="field">
          <label>{{form.comment.label}}</label>
          {{form.comment}}
          {{form.comment.errors}}
       </div>
           {% comment %} Form nomeclature {% endcomment %}
           <h4 class="ui dividing header">Номенклатуры в заявке</h4>
           <input type="hidden" name="nomenclature-TOTAL_FORMS" value={{count_form|default_if_none:'0'}} id="id_nomenclature-TOTAL_FORMS">
           {% for form_nomenclature in forms_nomenclature %}
           {% include "manufactures/nomenclature_form.html" with form=form_nomenclature %}
           {% endfor %}
           {% comment %} end from nomeclature {% endcomment %}
         <button class="ui button" id="add_nomenclature">Добавить номенклатуру</button>

  
      <button class="ui button positive" type="submit">{% firstof name_btn 'Создать' %}</button>
    </form>
  </div>

  <script>
    $('.ui.checkbox').checkbox();
    $('.selection.dropdown').dropdown();
    $('.ui.fluid.search.dropdown').dropdown();
    $('#date_calendar_date_shipment').calendar({
        type: "date", 
        firstDayOfWeek: 1,
        text: {
        days: ['В', 'П', 'В', 'С', 'Ч', 'П', 'С'],
          today: 'Сегодня',
          months: ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"],
          monthsShort: ["Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"],
        },
        formatter: {
          date: 'DD.MM.YYYY'
        }
      });

      const form = $("#form_nomenclature_0").clone()

      function add_nomenclature(){
        const new_form = form.clone();
        const input_count = $("#id_nomenclature-TOTAL_FORMS")
        const index = input_count.val()
        const new_index = parseInt(index) + 1
        input_count.val(new_index)
        new_form.attr("id", `id_nomenclature-${new_index}`)
        new_form.find("input").each(function(){
          const input = $(this)
          const name = input.attr("name")
          input.attr("name",  name.replace("0", new_index))
          const id = input.attr("id")
          input.attr("id", id.replace("0", new_index))
        })
        new_form.find("label").each(function(){
          const label = $(this)
          const for_label = label.attr("for")
          if (for_label) {
            label.attr("for", for_label.replace("0", new_index))
          }
        })   
        new_form.find("select").each(function(){
          const select = $(this)
          const id_select = select.attr("id")
          select.attr("id", id_select.replace("0", new_index))
          const name = select.attr("name")
          select.attr("name", name.replace("0", new_index))
          select.parent().dropdown();   
        })

        last_form = $(".form-nomenclature").last()
        last_form.after(new_form)
        
      }

      function activate_toggle(){
        $('.ui.checkbox').checkbox();
        $('.selection.dropdown').dropdown();
        $('.ui.fluid.search.dropdown').dropdown();
      }
      $("#add_nomenclature").click(function(e){
        e.preventDefault()
        add_nomenclature()
        activate_toggle()
      })

  </script>
  
{% endblock content %}