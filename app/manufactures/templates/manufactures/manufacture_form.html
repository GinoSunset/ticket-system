{% extends 'ticsys/index.html' %}
{% block content %}
<h1>{% firstof name_page 'Создание задачи на производство' %}</h1>
<a class="ui button info basic" href="{% url 'client-create' %}">Создать клиента</a>
<a class="ui button info basic" href="{% url 'nomenclature-create' %}">Создать номенклатуру</a>
<div class="ui container">
    <form class="ui form" method="post">
        {{ form.non_field_errors }}
        {% csrf_token %}
        {% for field in form %}
        <div class="ui field {% if field.widget_type == 'checkbox' %}right aligned toggle checkbox{% endif %} " >
            {{ field.errors }}
            {{ field.label_tag }} 
            {{ field }}
            {% if field.help_text %}
              <span class="ui small grey text">
                {{field.help_text}}
              </span>
              {% endif %}
        </div>
        {% endfor %}
            {% comment %} Form nomeclature {% endcomment %}
        <h4 class="ui dividing header">Номенклатуры в заявке</h4>
        <input type="hidden" name="nomenclature-TOTAL_FORMS" value="0" id="id_nomenclature-TOTAL_FORMS">
        <div class="two fields form-nomenclature" id="form_nomenclature_0" >
          <div class="field">
            {{form_nomenclature.nomenclature.errors}}
            {{form_nomenclature.nomenclature.label_tag}}
            {{form_nomenclature.nomenclature}}
          </div>
          <div class="field">
            {{form_nomenclature.quantity.errors}}
            {{form_nomenclature.quantity.label_tag}}
            {{form_nomenclature.quantity}}
          </div>
        </div>
        {% comment %} end from nomeclature {% endcomment %}
      <button class="ui button" id="add_nomenclature">Добавить номенклатуру</button>
      <button class="ui button" type="submit">{% firstof name_btn 'Создать' %}</button>
    </form>
  </div>

  <script>
    $('.ui.checkbox').checkbox();
    $('.selection.dropdown').dropdown();
    $('#date_calendar_date_shipment').calendar({
        type: "date", 
        firstDayOfWeek: 1,
        text: {
        days: ['В', 'П', 'В', 'С', 'Ч', 'П', 'С'],
          today: 'Сегодня',
          months: ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"],
          monthsShort: ["Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"],
        },
        formatter: {
          date: 'DD.MM.YYYY'
        }
      });
      const form = $("#form_nomenclature_0").clone()

      function add_nomenclature(){
        const input_count = $("#id_nomenclature-TOTAL_FORMS")
        const index = input_count.val()
        const new_index = parseInt(index) + 1
        input_count.val(new_index)
        form.attr("id", `id_nomenclature-${new_index}`)
        form.find("input").each(function(){
          const input = $(this)
          const name = input.attr("name")
          input.attr("name",  name.replace("0", new_index))
          const id = input.attr("id")
          input.attr("id", id.replace("0", new_index))
        })
        form.find("label").each(function(){
          const label = $(this)
          const for_label = label.attr("for")
          label.attr("for", for_label.replace("0", new_index))
        })   
        form.find("select").each(function(){
          const select = $(this)
          const id_select = select.attr("id")
          select.attr("id", id_select.replace("0", new_index))
          const name = select.attr("name")
          select.attr("name", name.replace("0", new_index))
          select.parent().dropdown();   
        })

        last_form = $(".form-nomenclature").last()
        last_form.after(form)
        
      }

      $("#add_nomenclature").click(function(e){
        e.preventDefault()
        add_nomenclature()
      })
  </script>
  
{% endblock content %}